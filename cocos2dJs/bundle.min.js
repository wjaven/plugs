var g_resources=['res/1.png','res/2.png','res/3.png','res/4.png','res/5.png','res/bg.jpg'];var GameLayer=cc.Layer.extend({mapPanel:null,ui:null,score:0,level:0,steps:0,limitStep:0,targetScore:0,ctor:function(){this._super();var a=cc.winSize;var b=new cc.Sprite('res/bg.jpg');this.addChild(b,1);b.x=a.width/2;b.y=a.height/2;var c=new cc.ClippingNode();this.addChild(c,2);this.mapPanel=new cc.Layer();this.mapPanel.x=(a.width-Constant.CANDY_WIDTH*Constant.MAP_SIZE)/2;this.mapPanel.y=(a.height-Constant.CANDY_WIDTH*Constant.MAP_SIZE)/2;c.addChild(this.mapPanel,1);var d=new cc.DrawNode();d.drawRect(cc.p(this.mapPanel.x,this.mapPanel.y),cc.p(this.mapPanel.x+Constant.CANDY_WIDTH*Constant.MAP_SIZE,this.mapPanel.y+Constant.CANDY_WIDTH*Constant.MAP_SIZE),cc.color(0,0,0),1,cc.color(0,0,0));c.stencil=d;this._init();this.ui=new GameUI(this);this.addChild(this.ui,3);if('touches'in cc.sys.capabilities){cc.eventManager.addListener({event:cc.EventListener.TOUCH_ONE_BY_ONE,onTouchBegan:this._onTouchBegan.bind(this)},this.mapPanel)}else{cc.eventManager.addListener({event:cc.EventListener.MOUSE,onMouseDown:this._onMouseDown.bind(this)},this.mapPanel)}},_init:function(){this.steps=0;this.level=Storage.getCurrentLevel();this.score=Storage.getCurrentScore();this.limitStep=Constant.levels[this.level].limitStep;this.targetScore=Constant.levels[this.level].targetScore;this.map=[];for(var i=0;i<Constant.MAP_SIZE;i++){var a=[];for(var j=0;j<Constant.MAP_SIZE;j++){var b=Candy.createRandomType(i,j);this.mapPanel.addChild(b);b.x=i*Constant.CANDY_WIDTH+Constant.CANDY_WIDTH/2;b.y=j*Constant.CANDY_WIDTH+Constant.CANDY_WIDTH/2;a.push(b)}this.map.push(a)}},_onTouchBegan:function(a,b){var c=Math.floor((a.getLocation().x-this.mapPanel.x)/Constant.CANDY_WIDTH);var d=Math.floor((a.getLocation().y-this.mapPanel.y)/Constant.CANDY_WIDTH);this._popCandy(c,d);return true},_onMouseDown:function(a){var b=Math.floor((a.getLocationX()-this.mapPanel.x)/Constant.CANDY_WIDTH);var c=Math.floor((a.getLocationY()-this.mapPanel.y)/Constant.CANDY_WIDTH);this._popCandy(b,c)},_popCandy:function(b,c){if(this.moving){return}var d=[this.map[b][c]];var e=0;var f=function(a){if(d.indexOf(a)<0){d.push(a)}};while(e<d.length){var g=d[e];if(this._checkCandyExist(g.column-1,g.row)&&this.map[g.column-1][g.row].type==g.type){f(this.map[g.column-1][g.row])}if(this._checkCandyExist(g.column+1,g.row)&&this.map[g.column+1][g.row].type==g.type){f(this.map[g.column+1][g.row])}if(this._checkCandyExist(g.column,g.row-1)&&this.map[g.column][g.row-1].type==g.type){f(this.map[g.column][g.row-1])}if(this._checkCandyExist(g.column,g.row+1)&&this.map[g.column][g.row+1].type==g.type){f(this.map[g.column][g.row+1])}e++}if(d.length<=1){return}this.steps++;this.moving=true;for(var i=0;i<d.length;i++){var g=d[i];this.mapPanel.removeChild(g);this.map[g.column][g.row]=null}this.score+=d.length*d.length;this._generateNewCandy();this._checkSucceedOrFail()},_checkCandyExist:function(i,j){if(i>=0&&i<Constant.MAP_SIZE&&j>=0&&j<Constant.MAP_SIZE){return true}return false},_generateNewCandy:function(){var a=0;for(var i=0;i<Constant.MAP_SIZE;i++){var b=0;for(var j=0;j<this.map[i].length;j++){var c=this.map[i][j];if(!c){var d=Candy.createRandomType(i,Constant.MAP_SIZE+b);this.mapPanel.addChild(d);d.x=d.column*Constant.CANDY_WIDTH+Constant.CANDY_WIDTH/2;d.y=d.row*Constant.CANDY_WIDTH+Constant.CANDY_WIDTH/2;this.map[i][d.row]=d;b++}else{var e=b;if(e>0&&c){var f=Math.sqrt(2*e/Constant.FALL_ACCELERATION);if(f>a){a=f}var g=cc.moveTo(f,c.x,c.y-Constant.CANDY_WIDTH*e).easing(cc.easeIn(2));c.runAction(g);c.row-=e;this.map[i][j]=null;this.map[i][c.row]=c}}}for(var j=this.map[i].length;j>=Constant.MAP_SIZE;j--){this.map[i].splice(j,1)}}this.scheduleOnce(this._finishCandyFalls.bind(this),a)},_finishCandyFalls:function(){this.moving=false},_checkSucceedOrFail:function(){if(this.score>=this.targetScore){this.ui.showSuccess();this.score+=(this.limitStep-this.steps)*30;Storage.setCurrentLevel(this.level+1);Storage.setCurrentScore(this.score);this.scheduleOnce(function(){cc.director.runScene(new GameScene())},3)}else if(this.steps>=this.limitStep){this.ui.showFail();Storage.setCurrentLevel(0);Storage.setCurrentScore(0);this.scheduleOnce(function(){cc.director.runScene(new GameScene())},3)}}});var GameScene=cc.Scene.extend({onEnter:function(){this._super();var a=new GameLayer();this.addChild(a)}});var Constant={CANDY_WIDTH:64,CANDY_TYPE_COUNT:5,MAP_SIZE:10,FALL_ACCELERATION:30,levels:[{limitStep:30,targetScore:500},{limitStep:25,targetScore:1000},{limitStep:20,targetScore:2000},{limitStep:20,targetScore:3000},{limitStep:15,targetScore:4000},{limitStep:10,targetScore:10000}]};var Storage={getCurrentLevel:function(){var a=cc.sys.localStorage.getItem('level')||0;return parseInt(a)},setCurrentLevel:function(a){cc.sys.localStorage.setItem('level',a);return true},getCurrentScore:function(){var a=cc.sys.localStorage.getItem('score')||0;return parseInt(a)},setCurrentScore:function(a){cc.sys.localStorage.setItem('score',a);return true},};var GameUI=cc.Layer.extend({levelText:null,scoreText:null,stepText:null,ctor:function(a){this._super();this.gameLayer=a;this._initInfoPabel();this.scheduleUpdate()},_initInfoPabel:function(){var a=cc.director.getWinSize();var b=new cc.LabelTTF('Level','arial',36);b.x=100;b.y=a.height-50;b.setColor(cc.color(0,0,0));this.addChild(b);var c=new cc.LabelTTF('1','arial',36);c.x=100;c.y=b.y-40;c.setColor(cc.color(0,0,0));this.addChild(c);this.levelText=c;var d=new cc.LabelTTF('Score','arial',36);d.x=370;d.y=b.y;d.setColor(cc.color(0,0,0));this.addChild(d);var e=new cc.LabelTTF('1','arial',36);e.x=370;e.y=c.y;e.setColor(cc.color(0,0,0));this.addChild(e);this.scoreText=e;var f=new cc.LabelTTF('Step','arial',36);f.x=620;f.y=b.y;f.setColor(cc.color(0,0,0));this.addChild(f);var g=new cc.LabelTTF('1','arial',36);g.x=620;g.y=c.y;g.setColor(cc.color(0,0,0));this.addChild(g);this.stepText=g},update:function(){this.levelText.setString(''+(this.gameLayer.level+1));this.scoreText.setString(''+(this.gameLayer.score));this.stepText.setString(''+(this.gameLayer.limitStep-this.gameLayer.steps))},showSuccess:function(){var a=new cc.LayerColor(cc.color(255,255,255),500,200);this.addChild(a,1);var b=cc.director.getWinSize();a.x=(b.width-a.width)/2;a.y=(b.height-a.height)/2;var c=new cc.LabelTTF('恭喜，完成第'+(this.gameLayer.level+1)+'关，\n剩余步数30倍奖励！','arial',28);c.setColor(cc.color(0,0,0));c.x=250;c.y=100;a.addChild(c)},showFail:function(){var a=new cc.LayerColor(cc.color(255,255,255),500,200);this.addChild(a,1);var b=cc.director.getWinSize();a.x=(b.width-a.width)/2;a.y=(b.height-a.height)/2;var c=new cc.LabelTTF('失败了，\n从头来过吧！','arial',28);c.setColor(cc.color(0,0,0));c.x=250;c.y=100;a.addChild(c)}});var Candy=cc.Sprite.extend({type:0,column:0,row:0,ctor:function(a,b,c){this._super('res/'+(a+1)+'.png');this.init(a,b,c)},init:function(a,b,c){this.type=a;this.column=b;this.row=c}});Candy.createRandomType=function(a,b){return new Candy(parseInt(Math.random()*Constant.CANDY_TYPE_COUNT),a,b)};cc.game.onStart=function(){cc.view.adjustViewPort();cc.view.setDesignResolutionSize(720,1280,cc.ResolutionPolicy.SHOW_ALL);cc.view.resizeWithBrowserSize();cc.LoaderScene.preload(g_resources,function(){cc.director.runScene(new GameScene())},this)};cc.game.run();
